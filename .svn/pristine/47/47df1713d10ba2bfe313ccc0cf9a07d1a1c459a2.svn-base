/*
 * az61.db.userLesson
 *
 * Created: 21.11..2013
 * Author: Rebeca Kurz <rk@inmedias.de>
 * Company: team in medias GmbH
 */

//Gets longterm Items
function GetAllLongtermItems(userId) {
	db.transaction(function(tx) {
		tx.executeSql('SELECT COUNT(LearnItem.LessonId) as count,* FROM LearnItem '+
		'INNER JOIN UserLessons ON LearnItem.LessonId = UserLessons.lesson_id '+
		'INNER JOIN Lesson ON LearnItem.LessonId = Lesson.LessonId '+
		'INNER JOIN Category ON Lesson.CategoryId = Category.CategoryId WHERE IsLongterm = 1 AND UserLessons.user_id = ' + userId + ' GROUP BY Category.CategoryName;', [],
	 	function(tx, result) {
			if (result != null && result.rows != null) {
				var lessonCount = 0;				

	    		for (var i = 0; i < result.rows.length; i++) {
	      			var row = result.rows.item(i);
	      			lessonCount = lessonCount + row.count;

	      			$('div.longtermList').append('<li id="longterm_'+ row.LessonId +'"><span class="longtermCategory">'+ row.CategoryName +'</span><span class="longtermCategory">'+ row.count +'</span>'+
	      			'<span class="enterLongterm"><img class="enterLongtermIcon pointer" src="img/forward.png"></span></li>');
	        	}
	        	
	        	var lessonText = 'FÃ¤chern';
	        	if (result.rows.length == 1){
	        		lessonText = 'Fach';
	        	}
	        	$('.longtermCount').html('Insgesamt: ' + lessonCount + ' Vokabeln in ' + result.rows.length + ' ' + lessonText);
	      	}
		}, errorCB);
		
	},errorCB,nullHandler);
}

function GetLongtermFromLesson(userId, lessonData){
	db.transaction(function(tx) {
		doQuery(tx, 'SELECT Result.learnItem_id as lItemId,* FROM LearnItem INNER JOIN Result ON LearnItem.LearnItemId = Result.learnItem_id'+
		' WHERE LessonId ='+lessonData['lessonId']+' AND Result.user_id ='+userId+' ORDER BY LearnItem.LearnItemId;', [],function(tx,result){
			if (result != null && result.rows != null) {
				var longtermLesson = {};
						
	    		for (var i = 0; i < result.rows.length; i++) {
	      			var row = result.rows.item(i);
	      			/*lessonCount = lessonCount + row.count;*/
					$('.longtermContent ul').append('<li id="learnItemId_'+row.lItemId+'"></li>');
	      			$('.longtermContent li#learnItemId_'+row.lItemId).append('<div id="questionLearnItem_'+row.lItemId+'" class="question"><span class="header"></span>'+
	      			'<input class="longterm" type="text" readonly="readonly" value="'+row.Question+'"/><input class="answerValue" type="hidden" value="'+row.Answer+'"/>'+
	      			'<span class="vocabLevel">'+row.LongtermLevel+'</span></div><div id="answerlearnItem_'+row.lItemId+'" class="answer"><span class="header"></span><input class="longterm answerUser" type="text" name="answer" /></div>');
	        	}
	      	}
	      	$(".rslides").responsiveSlides({
                auto: false,            // Boolean: Animate automatically, true or false
                pager: false,           // Boolean: Show pager, true or false
                nav: true,              // Boolean: Show navigation, true or false
                random: false,          // Boolean: Randomize the order of the slides, true or false
                pause: false,           // Boolean: Pause on hover, true or false
                pauseControls: true,    // Boolean: Pause when hovering controls, true or false
                prevText: "",           // String: Text for the "previous" button
                nextText: "Weiter",     // String: Text for the "next" button
                maxwidth: "",           // Integer: Max-width of the slideshow, in pixels
                navContainer: "div.longtermLearn",  // Selector: Where controls should be appended to, default is after the 'ul'
                manualControls: "",     // Selector: Declare custom pager navigation
            });
		});
	});
}

//Add Result to DB
function AddResultToDB(resultItem){
    console.log('test');
	var learnItemId = resultItem['learnItemId'];
	var userId = resultItem['userId'];
	var lastShown = resultItem['lastShown'];
	var longtermLevel = resultItem['longtermLevel'];
    
	db.transaction(function(tx) {
		doQuery(tx, 'INSERT INTO Result(user_id, learnItem_id, LastShown, LongtermLevel)'+
			'VALUES('+userId+','+learnItemId+',"'+lastShown+'",'+longtermLevel+')',[],querySuccessInsert);
	});
	
 	return;
}

//Update Result to the Database
function UpdateResultToDB(resultItem){
	var learnItemId = resultItem['learnItemId'];
	var userId = resultItem['userId'];
	var lastShown = resultItem['lastShown'];
	var longtermLevel = resultItem['longtermLevel'];
	
	var updateStatement = 'LastShown ="'+lastShown+'",LongtermLevel ='+longtermLevel;
	
	db.transaction(function(tx) {
		doQuery(tx, 'UPDATE Result SET '+ updateStatement +' WHERE user_id='+userId+' AND learnItem_id='+learnItemId+';',[],querySuccessUpdate);
	});
	return false;
}

//Remove Result from the Database
function DeleteResultFromDB(resultItem){
    var learnItemId = resultItem['learnItemId'];
    var userId = resultItem['userId'];
    
    db.transaction(function(tx) {
        doQuery(tx, 'DELETE FROM Result WHERE user_id='+userId+' AND learnItem_id='+learnItemId+';',[],querySuccess);
    });
    return false;
}
